image: jmgprog/flutter:0.5.1

stages:
  - test
  - deploy

format:
  stage: test
  script:
    - if flutter format lib test example/lib | grep 'Formatted'; then exit 1; fi

test:
  stage: test
  cache:
    key: flutter-test
    paths:
      - .pub-cache
  before_script:
    - export PUB_CACHE="$(pwd)/.pub-cache"
  script:
    - flutter test

publish:
  stage: deploy
  only:
    - tags
  before_script:
    - printf "$PUB_CREDENTIALS" | base64 -d > "$HOME/.pub-cache/credentials.json"
  script:
    - 'sed -i "s/version: .*/version: $CI_COMMIT_TAG/" pubspec.yaml'
    - cat pubspec.yaml
    - flutter pub pub publish --force
